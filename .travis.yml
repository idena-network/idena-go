dist: xenial
language: go

os:
  - linux
  - osx
  - windows

env:
  - GO111MODULE=on

go:
  - 1.12.x

branches:
  only:
    - master
    - /fork\/\d+\.\d+\.\d+/
    - /v\d+\.\d+\.\d+/

cache:
  directories:
    - $GOPATH/pkg/mod

git:
  depth: 1

install: true

before_script:
  - export VERSION=${TRAVIS_TAG:1}
  - export BRANCH_BUILD_ALL_REGEX="/offline/"

script:
  - go test -v ./...
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then go build -ldflags "-X main.version=${VERSION}" -o=builds/idena-node-linux-$VERSION; fi
  - if [[ "$TRAVIS_OS_NAME" == "windows" && "$TRAVIS_BRANCH" =~ $BRANCH_BUILD_ALL_REGEX ]]; then go build -ldflags "-X main.version=${VERSION}" -o=builds/idena-node-win-$VERSION.exe; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx"  && "$TRAVIS_BRANCH" =~ $BRANCH_BUILD_ALL_REGEX ]]; then go build -ldflags "-X main.version=${VERSION}" -o=builds/idena-node-mac-$VERSION; fi

deploy:
  provider: releases
  api_key: "$GH_TOKEN"
  file_glob: true
  file: builds/*
  skip_cleanup: true
  on:
    tags: true